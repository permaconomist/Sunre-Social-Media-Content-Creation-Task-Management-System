<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sunre AdContent | Task Management System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
    <style>
        :root { --glass: rgba(255, 255, 255, 0.03); --glass-border: rgba(255, 255, 255, 0.1); }
        body { background: #050505; color: #e5e5e5; font-family: 'Inter', sans-serif; overflow-x: hidden; }
        .glass-panel { background: var(--glass); backdrop-filter: blur(12px); border: 1px solid var(--glass-border); border-radius: 16px; }
        .status-dot { width: 8px; height: 8px; border-radius: 50%; display: inline-block; }
        .on-track { background: #10b981; box-shadow: 0 0 8px #10b981; }
        .at-risk { background: #f59e0b; box-shadow: 0 0 8px #f59e0b; }
        .delayed { background: #ef4444; box-shadow: 0 0 8px #ef4444; }
        input, textarea, select { background: rgba(255,255,255,0.05) !important; border: 1px solid rgba(255,255,255,0.1) !important; color: white !important; border-radius: 8px !important; }
        input:focus, textarea:focus, select:focus { border-color: #ffd447 !important; outline: none; }
        .tab-active { border-bottom: 2px solid #ffd447; color: #ffd447; }
        .hidden { display: none !important; }
    </style>
</head>
<body class="p-4 md:p-8">

    <!-- Auth Gateway -->
    <div id="auth-gate" class="fixed inset-0 z-50 bg-black flex items-center justify-center p-6 hidden">
        <div class="max-w-md w-full glass-panel p-8">
            <div class="text-center mb-8">
                <h1 class="text-3xl font-bold mb-2 leading-tight">Sunre <span class="text-yellow-400">AdContent</span></h1>
                <div class="flex justify-center gap-4 text-xs font-bold uppercase tracking-widest text-gray-500 mt-4">
                    <button onclick="toggleAuthMode('login')" id="btn-mode-login" class="text-yellow-400 border-b border-yellow-400 pb-1">Login</button>
                    <button onclick="toggleAuthMode('register')" id="btn-mode-register" class="hover:text-white transition pb-1">Register</button>
                </div>
            </div>
            
            <form id="login-form" class="space-y-4">
                <input type="email" id="login-email" required class="w-full p-3" placeholder="Email Address">
                <input type="password" id="login-password" required class="w-full p-3" placeholder="Password">
                <button type="submit" id="auth-btn" class="w-full bg-yellow-400 text-black font-bold p-3 rounded hover:bg-yellow-300 transition">Sign In</button>
            </form>

            <form id="register-form" class="space-y-4 hidden">
                <input type="text" id="reg-name" required class="w-full p-3" placeholder="Full Name">
                <input type="email" id="reg-email" required class="w-full p-3" placeholder="Email Address">
                <input type="password" id="reg-password" required class="w-full p-3" placeholder="Password (Min 6 chars)">
                <input type="password" id="reg-confirm" required class="w-full p-3" placeholder="Confirm Password">
                <button type="submit" id="reg-btn" class="w-full bg-white text-black font-bold p-3 rounded hover:bg-gray-200 transition">Request Access</button>
            </form>
        </div>
    </div>

    <!-- Pending Approval Screen -->
    <div id="pending-gate" class="fixed inset-0 z-50 bg-black flex items-center justify-center p-6 hidden">
        <div class="max-w-md w-full glass-panel p-10 text-center border-yellow-400/30">
            <h1 class="text-2xl font-bold mb-4">Account <span class="text-yellow-400">Pending</span></h1>
            <p class="text-gray-400 mb-8 leading-relaxed">Your request has been submitted. Please wait for admin approval before you can access the workspace.</p>
            <button onclick="handleLogout()" class="text-xs uppercase font-bold text-gray-500 hover:text-white transition tracking-widest">Return to Login</button>
        </div>
    </div>

    <!-- Main App Content -->
    <div id="app-content" class="hidden">
        <header class="max-w-7xl mx-auto flex flex-col md:flex-row justify-between items-start md:items-center gap-4 mb-8">
            <div>
                <h1 class="text-xl font-black tracking-tight">SUNRE <span class="text-yellow-400">ADCONTENT</span></h1>
                <p class="text-gray-500 text-[10px] uppercase font-bold tracking-widest" id="user-context">
                    <span id="user-role-badge" class="bg-white/10 px-2 py-0.5 rounded mr-2 text-yellow-400">Role</span>
                    <span id="current-user-display">Loading...</span>
                </p>
            </div>
            <div class="flex gap-2">
                <button onclick="switchView('creator')" id="tab-creator" class="px-4 py-2 text-sm font-semibold tab-active">My Tasks</button>
                <button onclick="switchView('ceo')" id="tab-ceo" class="px-4 py-2 text-sm font-semibold text-gray-500 hidden">Admin Panel</button>
                <button onclick="handleLogout()" class="px-4 py-2 text-sm font-semibold text-red-400 hover:bg-red-400/10 rounded transition">Logout</button>
            </div>
        </header>

        <main class="max-w-7xl mx-auto">
            <!-- CREATOR VIEW -->
            <section id="view-creator" class="grid grid-cols-1 lg:grid-cols-12 gap-6">
                <div class="lg:col-span-4 space-y-4">
                    <div class="glass-panel p-6">
                        <h2 class="text-lg font-bold mb-4 text-yellow-400">Task Update</h2>
                        <form id="session-form" class="space-y-4">
                            <input type="text" id="campaign" required class="w-full p-2" placeholder="Campaign Name">
                            <div class="grid grid-cols-2 gap-2">
                                <select id="stage" class="w-full p-2">
                                    <option value="brief">Briefing</option>
                                    <option value="ai">AI Gen</option>
                                    <option value="edit">Editing</option>
                                    <option value="review">Review</option>
                                </select>
                                <select id="ceo_status" class="w-full p-2">
                                    <option value="on-track">On Track</option>
                                    <option value="at-risk">At Risk</option>
                                    <option value="delayed">Delayed</option>
                                </select>
                            </div>
                            <textarea id="objective" rows="2" class="w-full p-2" placeholder="Task Objective"></textarea>
                            <textarea id="blockers" rows="2" class="w-full p-2" placeholder="Current Blockers"></textarea>
                            <button type="submit" class="w-full bg-white text-black font-bold py-3 rounded-lg hover:bg-gray-200 transition">Update Status</button>
                        </form>
                    </div>
                </div>

                <div class="lg:col-span-8">
                    <div class="glass-panel overflow-hidden">
                        <div class="p-4 border-b border-white/10 bg-white/5 font-bold">Activity Feed</div>
                        <div id="session-list" class="divide-y divide-white/5 p-4 space-y-4">
                            <div class="text-center py-10 text-gray-600">Syncing with server...</div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- CEO MONITOR VIEW -->
            <section id="view-ceo" class="hidden space-y-6">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="glass-panel overflow-hidden">
                        <div class="p-4 border-b border-white/10 bg-white/5">
                            <h2 class="font-bold text-yellow-400 text-sm">User Management</h2>
                        </div>
                        <div class="p-4 overflow-x-auto">
                            <table class="w-full text-left text-xs">
                                <thead class="uppercase text-gray-500">
                                    <tr>
                                        <th class="p-2">Name</th>
                                        <th class="p-2">Role</th>
                                        <th class="p-2">Status</th>
                                        <th class="p-2">Action</th>
                                    </tr>
                                </thead>
                                <tbody id="user-manage-body" class="divide-y divide-white/5"></tbody>
                            </table>
                        </div>
                    </div>
                    <div class="grid grid-cols-1 gap-4">
                        <div class="glass-panel p-6 border-l-4 border-green-500 flex justify-between items-center">
                            <span class="text-gray-400">On Track</span>
                            <h3 class="text-2xl font-bold" id="stat-on-track">0</h3>
                        </div>
                        <div class="glass-panel p-6 border-l-4 border-yellow-500 flex justify-between items-center">
                            <span class="text-gray-400">At Risk</span>
                            <h3 class="text-2xl font-bold" id="stat-at-risk">0</h3>
                        </div>
                        <div class="glass-panel p-6 border-l-4 border-red-500 flex justify-between items-center">
                            <span class="text-gray-400">Delayed</span>
                            <h3 class="text-2xl font-bold" id="stat-delayed">0</h3>
                        </div>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <div id="toast" class="fixed bottom-8 left-1/2 -translate-x-1/2 glass-panel px-6 py-3 text-sm font-semibold opacity-0 pointer-events-none transition-all duration-300 z-[100]"></div>

    <script>
        /**
         * SUPABASE INITIALIZATION
         */
        const HARDCODED_URL = "https://Iv6Tt-L4VtsN53aoqGLQzw.supabase.co"; 
        const HARDCODED_KEY = "sb_publishable_Iv6Tt-L4VtsN53aoqGLQzw_Wp66r189";

        let supabaseClient = null; 
        let currentUser = null;
        let profile = null;

        window.onload = async () => {
            initSupabase(HARDCODED_URL, HARDCODED_KEY);
        };

        async function initSupabase(url, key) {
            supabaseClient = supabase.createClient(url, key);
            const { data: { session } } = await supabaseClient.auth.getSession();
            if (session) {
                currentUser = session.user;
                await fetchProfile();
            } else {
                document.getElementById('auth-gate').classList.remove('hidden');
            }
        }

        async function fetchProfile() {
            const { data } = await supabaseClient.from('profiles').select('*').eq('id', currentUser.id).single();
            if (data) {
                profile = data;
                if (profile.status === 'pending') {
                    document.getElementById('pending-gate').classList.remove('hidden');
                } else {
                    onAuthenticated();
                }
            } else {
                handleLogout();
            }
        }

        function onAuthenticated() {
            document.getElementById('auth-gate').classList.add('hidden');
            document.getElementById('pending-gate').classList.add('hidden');
            document.getElementById('app-content').classList.remove('hidden');
            
            if (['ceo', 'admin', 'aiarchitect'].includes(profile.role)) {
                document.getElementById('tab-ceo').classList.remove('hidden');
            }

            document.getElementById('current-user-display').textContent = profile.name || currentUser.email;
            document.getElementById('user-role-badge').textContent = profile.role;
            
            fetchSessions();
        }

        async function fetchSessions() {
            const query = supabaseClient.from('sessions').select('*');
            if (profile.role === 'creator') query.eq('user_id', currentUser.id);
            const { data } = await query.order('created_at', { ascending: false });
            if (data) renderSessions(data);
        }

        function renderSessions(sessions) {
            const container = document.getElementById('session-list');
            container.innerHTML = sessions.map(s => `
                <div class="p-4 border border-white/5 rounded-lg bg-white/5">
                    <div class="flex justify-between items-start mb-2">
                        <h3 class="font-bold text-yellow-400 text-sm">${s.campaign}</h3>
                        <span class="text-[9px] uppercase font-bold px-2 py-0.5 rounded bg-white/10">${s.stage}</span>
                    </div>
                    <p class="text-[11px] text-gray-400 mb-3">${s.objective || ''}</p>
                    <div class="flex items-center gap-2 text-[9px] uppercase font-bold">
                        <span class="status-dot ${s.ceo_status}"></span>
                        <span class="text-gray-600">${new Date(s.created_at).toLocaleDateString()}</span>
                    </div>
                </div>
            `).join('');
            
            if (profile.role !== 'creator') {
                const stats = { onTrack: 0, atRisk: 0, delayed: 0 };
                sessions.forEach(s => {
                    if (s.ceo_status === 'on-track') stats.onTrack++;
                    if (s.ceo_status === 'at-risk') stats.atRisk++;
                    if (s.ceo_status === 'delayed') stats.delayed++;
                });
                document.getElementById('stat-on-track').textContent = stats.onTrack;
                document.getElementById('stat-at-risk').textContent = stats.atRisk;
                document.getElementById('stat-delayed').textContent = stats.delayed;
            }
        }

        function switchView(view) {
            document.getElementById('view-creator').classList.toggle('hidden', view !== 'creator');
            document.getElementById('view-ceo').classList.toggle('hidden', view !== 'ceo');
            document.getElementById('tab-creator').className = view === 'creator' ? 'px-4 py-2 text-sm font-semibold tab-active' : 'px-4 py-2 text-sm font-semibold text-gray-500';
            document.getElementById('tab-ceo').className = view === 'ceo' ? 'px-4 py-2 text-sm font-semibold tab-active' : 'px-4 py-2 text-sm font-semibold text-gray-500';
            if (view === 'ceo') fetchAllUsers();
        }

        async function fetchAllUsers() {
            const { data } = await supabaseClient.from('profiles').select('*');
            const body = document.getElementById('user-manage-body');
            body.innerHTML = data.map(u => `
                <tr class="hover:bg-white/5">
                    <td class="p-2">${u.name}</td>
                    <td class="p-2">
                        <select onchange="updateUserRole('${u.id}', this.value)" class="bg-transparent text-[10px] font-bold text-yellow-400">
                            <option value="creator" ${u.role === 'creator' ? 'selected' : ''}>Creator</option>
                            <option value="ceo" ${u.role === 'ceo' ? 'selected' : ''}>CEO</option>
                        </select>
                    </td>
                    <td class="p-2">
                        <span class="text-[9px] px-1.5 py-0.5 rounded ${u.status === 'active' ? 'bg-green-500/20 text-green-400' : 'bg-red-500/20 text-red-400'}">${u.status}</span>
                    </td>
                    <td class="p-2">
                        <button onclick="updateUserStatus('${u.id}', '${u.status === 'active' ? 'pending' : 'active'}')" class="text-[10px] uppercase font-bold text-gray-400 hover:text-white">Toggle</button>
                    </td>
                </tr>
            `).join('');
        }

        async function updateUserStatus(uid, status) {
            const { error } = await supabaseClient.from('profiles').update({ status }).eq('id', uid);
            if (!error) { showToast("Sync Complete"); fetchAllUsers(); }
        }

        async function updateUserRole(uid, role) {
            const { error } = await supabaseClient.from('profiles').update({ role }).eq('id', uid);
            if (!error) showToast("Permissions Updated");
        }

        document.getElementById('session-form').onsubmit = async (e) => {
            e.preventDefault();
            const { error } = await supabaseClient.from('sessions').insert([{
                user_id: currentUser.id,
                campaign: document.getElementById('campaign').value,
                stage: document.getElementById('stage').value,
                ceo_status: document.getElementById('ceo_status').value,
                objective: document.getElementById('objective').value,
                blockers: document.getElementById('blockers').value
            }]);
            if (!error) { showToast("Update Saved"); e.target.reset(); fetchSessions(); }
            else { showToast("Error: check permissions"); }
        };

        function toggleAuthMode(mode) {
            const isLogin = mode === 'login';
            document.getElementById('login-form').classList.toggle('hidden', !isLogin);
            document.getElementById('register-form').classList.toggle('hidden', isLogin);
        }

        async function handleLogout() {
            if (supabaseClient) await supabaseClient.auth.signOut();
            location.reload();
        }

        function showToast(msg) {
            const t = document.getElementById('toast');
            t.textContent = msg;
            t.className = `fixed bottom-8 left-1/2 -translate-x-1/2 glass-panel px-6 py-3 text-sm font-semibold opacity-100 z-[100] border-yellow-400 text-yellow-400`;
            setTimeout(() => t.style.opacity = '0', 2500);
        }

        document.getElementById('login-form').onsubmit = async (e) => {
            e.preventDefault();
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            const { data, error } = await supabaseClient.auth.signInWithPassword({ email, password });
            if (error) showToast("Invalid Credentials");
            else location.reload();
        };

        document.getElementById('register-form').onsubmit = async (e) => {
            e.preventDefault();
            const name = document.getElementById('reg-name').value;
            const email = document.getElementById('reg-email').value;
            const password = document.getElementById('reg-password').value;
            const { data, error } = await supabaseClient.auth.signUp({ email, password });
            if (error) showToast(error.message);
            else {
                await supabaseClient.from('profiles').insert([{ id: data.user.id, name, email, status: 'pending', role: 'creator' }]);
                location.reload();
            }
        };
    </script>
</body>
</html>
