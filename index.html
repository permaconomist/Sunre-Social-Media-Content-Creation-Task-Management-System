<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sunre AdContent | Task Management System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
    <style>
        :root { --glass: rgba(255, 255, 255, 0.03); --glass-border: rgba(255, 255, 255, 0.1); }
        body { background: #050505; color: #e5e5e5; font-family: 'Inter', sans-serif; overflow-x: hidden; }
        .glass-panel { background: var(--glass); backdrop-filter: blur(12px); border: 1px solid var(--glass-border); border-radius: 16px; }
        .status-dot { width: 8px; height: 8px; border-radius: 50%; display: inline-block; }
        .on-track { background: #10b981; box-shadow: 0 0 8px #10b981; }
        .at-risk { background: #f59e0b; box-shadow: 0 0 8px #f59e0b; }
        .delayed { background: #ef4444; box-shadow: 0 0 8px #ef4444; }
        input, textarea, select { background: rgba(255,255,255,0.05) !important; border: 1px solid rgba(255,255,255,0.1) !important; color: white !important; border-radius: 8px !important; }
        input:focus, textarea:focus, select:focus { border-color: #ffd447 !important; outline: none; }
        .tab-active { border-bottom: 2px solid #ffd447; color: #ffd447; }
        .hidden { display: none !important; }
    </style>
</head>
<body class="p-4 md:p-8">

    <!-- Setup Gate -->
    <div id="setup-gate" class="fixed inset-0 z-[100] bg-black flex items-center justify-center p-6 hidden">
        <div class="max-w-md w-full glass-panel p-8 text-center border-yellow-400/20">
            <h1 class="text-2xl font-bold mb-2">Workspace <span class="text-yellow-400">Setup</span></h1>
            <p class="text-xs text-gray-500 mb-6 uppercase tracking-widest">Connect your Supabase Project</p>
            <div class="space-y-4 text-left">
                <div>
                    <label class="text-[10px] uppercase font-bold text-gray-400 ml-1">Project URL</label>
                    <input type="text" id="setup-url" placeholder="https://your-id.supabase.co" class="w-full p-3 mt-1">
                </div>
                <div>
                    <label class="text-[10px] uppercase font-bold text-gray-400 ml-1">Anon Key</label>
                    <input type="password" id="setup-key" placeholder="your-public-anon-key" class="w-full p-3 mt-1">
                </div>
                <button onclick="handleSetupSubmit()" class="w-full bg-yellow-400 text-black font-bold p-4 rounded-lg hover:bg-yellow-300 transition mt-4">Initialize System</button>
            </div>
        </div>
    </div>

    <!-- Auth Gateway -->
    <div id="auth-gate" class="fixed inset-0 z-50 bg-black flex items-center justify-center p-6 hidden">
        <div class="max-w-md w-full glass-panel p-8">
            <div class="text-center mb-8">
                <h1 class="text-3xl font-bold mb-2">Sunre <span class="text-yellow-400">AdContent</span></h1>
                <div class="flex justify-center gap-4 text-xs font-bold uppercase tracking-widest text-gray-500 mt-4">
                    <button onclick="toggleAuthMode('login')" id="btn-mode-login" class="text-yellow-400 border-b border-yellow-400 pb-1">Login</button>
                    <button onclick="toggleAuthMode('register')" id="btn-mode-register" class="hover:text-white transition pb-1">Register</button>
                </div>
            </div>
            
            <form id="login-form" class="space-y-4">
                <input type="email" id="login-email" required class="w-full p-3" placeholder="Email Address">
                <input type="password" id="login-password" required class="w-full p-3" placeholder="Password">
                <button type="submit" id="auth-btn" class="w-full bg-yellow-400 text-black font-bold p-3 rounded hover:bg-yellow-300 transition">Sign In</button>
            </form>

            <form id="register-form" class="space-y-4 hidden">
                <input type="text" id="reg-name" required class="w-full p-3" placeholder="Full Name">
                <input type="email" id="reg-email" required class="w-full p-3" placeholder="Email Address">
                <input type="password" id="reg-password" required class="w-full p-3" placeholder="Password">
                <input type="password" id="reg-confirm" required class="w-full p-3" placeholder="Confirm Password">
                <button type="submit" id="reg-btn" class="w-full bg-white text-black font-bold p-3 rounded hover:bg-gray-200 transition">Request Access</button>
            </form>
        </div>
    </div>

    <!-- Pending Approval Screen -->
    <div id="pending-gate" class="fixed inset-0 z-50 bg-black flex items-center justify-center p-6 hidden">
        <div class="max-w-md w-full glass-panel p-10 text-center border-yellow-400/30">
            <h1 class="text-2xl font-bold mb-4">Account <span class="text-yellow-400">Pending</span></h1>
            <p class="text-gray-400 mb-8 leading-relaxed">Please wait for admin approval.</p>
            <button onclick="handleLogout()" class="text-xs uppercase font-bold text-gray-500 hover:text-white transition">Return to Login</button>
        </div>
    </div>

    <!-- Main App Content -->
    <div id="app-content" class="hidden">
        <header class="max-w-7xl mx-auto flex justify-between items-center mb-8">
            <h1 class="text-xl font-black">SUNRE <span class="text-yellow-400">ADCONTENT</span></h1>
            <div class="flex gap-4">
                <span id="user-display" class="text-sm text-gray-400 self-center"></span>
                <button onclick="handleLogout()" class="text-red-400 text-sm font-bold">Logout</button>
            </div>
        </header>

        <main class="max-w-7xl mx-auto grid grid-cols-1 lg:grid-cols-12 gap-6">
            <!-- Sidebar/Form -->
            <div class="lg:col-span-4 space-y-4">
                <div class="glass-panel p-6">
                    <h2 class="text-lg font-bold mb-4">New Task Update</h2>
                    <form id="task-form" class="space-y-4">
                        <input type="text" id="campaign" required class="w-full p-2" placeholder="Campaign Name">
                        <select id="stage" class="w-full p-2">
                            <option value="briefing">Briefing</option>
                            <option value="ai-gen">AI Gen</option>
                            <option value="editing">Editing</option>
                            <option value="review">Review</option>
                        </select>
                        <select id="status" class="w-full p-2">
                            <option value="on-track">On Track</option>
                            <option value="at-risk">At Risk</option>
                            <option value="delayed">Delayed</option>
                        </select>
                        <textarea id="objective" rows="2" class="w-full p-2" placeholder="Task Objective"></textarea>
                        <button type="submit" class="w-full bg-yellow-400 text-black font-bold py-3 rounded-lg hover:bg-yellow-300 transition">Sync Update</button>
                    </form>
                </div>
            </div>

            <!-- Feed -->
            <div class="lg:col-span-8">
                <div class="glass-panel min-h-[400px]">
                    <div class="p-4 border-b border-white/10 bg-white/5 font-bold">Activity Feed</div>
                    <div id="task-list" class="p-4 space-y-4">
                        <!-- Tasks appear here -->
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script>
        // Use empty strings to trigger setup gate, or fill them to bypass it
        const HARDCODED_URL = ""; 
        const HARDCODED_KEY = ""; 

        let supabaseClient = null;
        let currentUser = null;

        window.onload = () => {
            const url = HARDCODED_URL || localStorage.getItem('sunre_url');
            const key = HARDCODED_KEY || localStorage.getItem('sunre_key');

            if (url && key) {
                init(url, key);
            } else {
                document.getElementById('setup-gate').classList.remove('hidden');
            }
        };

        function handleSetupSubmit() {
            const u = document.getElementById('setup-url').value.trim();
            const k = document.getElementById('setup-key').value.trim();
            if (u && k) {
                localStorage.setItem('sunre_url', u);
                localStorage.setItem('sunre_key', k);
                location.reload();
            }
        }

        async function init(url, key) {
            supabaseClient = supabase.createClient(url, key);
            const { data: { session } } = await supabaseClient.auth.getSession();
            if (session) {
                currentUser = session.user;
                checkProfile();
            } else {
                document.getElementById('auth-gate').classList.remove('hidden');
            }
        }

        async function checkProfile() {
            const { data, error } = await supabaseClient.from('profiles').select('*').eq('id', currentUser.id).single();
            if (data) {
                if (data.status === 'active') {
                    showApp(data);
                } else {
                    document.getElementById('pending-gate').classList.remove('hidden');
                }
            } else {
                handleLogout();
            }
        }

        function showApp(profile) {
            document.getElementById('app-content').classList.remove('hidden');
            document.getElementById('user-display').textContent = profile.name;
            fetchTasks();
        }

        async function fetchTasks() {
            const { data } = await supabaseClient.from('sessions').select('*').order('created_at', { ascending: false });
            if (data) renderTasks(data);
        }

        function renderTasks(tasks) {
            const container = document.getElementById('task-list');
            container.innerHTML = tasks.map(t => `
                <div class="p-4 border border-white/5 rounded-lg bg-white/5">
                    <div class="flex justify-between items-start mb-2">
                        <h3 class="font-bold text-yellow-400">${t.campaign}</h3>
                        <span class="text-[10px] uppercase font-bold px-2 py-0.5 rounded bg-white/10">${t.stage}</span>
                    </div>
                    <p class="text-sm text-gray-400 mb-3">${t.objective || 'No objective set'}</p>
                    <div class="flex items-center gap-2 text-[10px] uppercase font-bold">
                        <span class="status-dot ${t.ceo_status}"></span>
                        <span class="text-gray-500">${new Date(t.created_at).toLocaleDateString()}</span>
                    </div>
                </div>
            `).join('');
        }

        // Form Handlers
        document.getElementById('login-form').onsubmit = async (e) => {
            e.preventDefault();
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            const { data, error } = await supabaseClient.auth.signInWithPassword({ email, password });
            if (error) alert(error.message);
            else location.reload();
        };

        document.getElementById('register-form').onsubmit = async (e) => {
            e.preventDefault();
            const name = document.getElementById('reg-name').value;
            const email = document.getElementById('reg-email').value;
            const password = document.getElementById('reg-password').value;
            
            const { data, error } = await supabaseClient.auth.signUp({ email, password });
            if (error) alert(error.message);
            else {
                await supabaseClient.from('profiles').insert([{ id: data.user.id, name, email, status: 'pending' }]);
                location.reload();
            }
        };

        document.getElementById('task-form').onsubmit = async (e) => {
            e.preventDefault();
            const payload = {
                user_id: currentUser.id,
                campaign: document.getElementById('campaign').value,
                stage: document.getElementById('stage').value,
                ceo_status: document.getElementById('status').value,
                objective: document.getElementById('objective').value
            };
            const { error } = await supabaseClient.from('sessions').insert([payload]);
            if (error) alert(error.message);
            else {
                e.target.reset();
                fetchTasks();
            }
        };

        function toggleAuthMode(mode) {
            const isLogin = mode === 'login';
            document.getElementById('login-form').classList.toggle('hidden', !isLogin);
            document.getElementById('register-form').classList.toggle('hidden', isLogin);
        }

        async function handleLogout() {
            if(supabaseClient) await supabaseClient.auth.signOut();
            location.reload();
        }
    </script>
</body>
</html>
